#!/usr/bin/env bash
# Post-commit hook to automatically update version.json with the latest commit SHA
# Note: This hook will amend the commit to include version.json

# Get the current commit SHA
CURRENT_COMMIT=$(git rev-parse HEAD)

# Check if version.json exists and already has this commit SHA
if [ -f "src/mimic/version.json" ]; then
    EXISTING_COMMIT=$(grep -o '"commit": "[^"]*"' src/mimic/version.json | cut -d'"' -f4)
    if [ "$EXISTING_COMMIT" = "$CURRENT_COMMIT" ]; then
        # version.json already has the correct commit SHA, we're done
        exit 0
    fi
fi

# Generate version.json with the current commit SHA
python scripts/generate-version.py || exit 0

# Check if version.json actually changed
if git diff --quiet src/mimic/version.json; then
    # No changes, skip amend
    exit 0
fi

# Add version.json and amend the commit
git add src/mimic/version.json
GIT_COMMITTER_DATE="$(git log -1 --format=%cD)" git commit --amend --no-edit --no-verify
